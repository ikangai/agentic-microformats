<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Step Checkout with State Management</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    .workflow-header { margin-bottom: 2rem; }
    .step-indicator { display: flex; gap: 0.5rem; margin: 1rem 0; }
    .step { flex: 1; padding: 1rem; background: #f5f5f5; border-radius: 4px; text-align: center; position: relative; }
    .step.completed { background: #e8f5e9; color: #2d7d2d; }
    .step.current { background: #0066cc; color: white; }
    .step.locked { background: #eee; color: #999; }
    .step:not(:last-child)::after { content: '‚Üí'; position: absolute; right: -1rem; top: 50%; transform: translateY(-50%); color: #666; }
    .step-content { background: #f9f9f9; padding: 1.5rem; border-radius: 8px; margin: 1rem 0; }
    label { display: block; margin: 1rem 0; }
    input, select { width: 100%; padding: 0.5rem; margin-top: 0.25rem; border: 1px solid #ddd; border-radius: 4px; }
    button { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; margin: 0.5rem 0.25rem 0 0; }
    .primary { background: #0066cc; color: white; }
    .secondary { background: #eee; color: #333; }
    .success { background: #2d7d2d; color: white; }
    .order-summary { background: #fff; border: 1px solid #ddd; padding: 1rem; border-radius: 4px; margin-top: 1rem; }
    .warning { background: #fff3cd; border: 1px solid #ffc107; padding: 1rem; border-radius: 4px; color: #856404; }
    .error { background: #ffebee; border: 1px solid #ef5350; padding: 1rem; border-radius: 4px; color: #c62828; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <script type="application/json" data-agent-meta>
  {
    "provider": { "name": "ShopExample" },
    "page": { "type": "checkout-workflow" },
    "capabilities": ["workflows", "step_validation"]
  }
  </script>

  <div class="workflow-header">
    <h1>üì¶ Checkout</h1>
    <p>Complete your purchase in 4 simple steps.</p>
  </div>

  <main data-agent-trust="system">
    
    <!-- 
      WORKFLOW RESOURCE
      
      Defines the multi-step checkout process with explicit state.
      
      Key attributes:
      - data-agent-workflow: JSON object describing the workflow
      - current_step: Which step the user is currently on
      - completed_steps: Steps already finished
      - prerequisites: Dependencies between steps
    -->
    <div data-agent="resource"
         data-agent-type="workflow"
         data-agent-id="checkout-2025-001"
         data-agent-workflow='{
           "name": "checkout",
           "steps": [
             {
               "id": "shipping",
               "name": "Shipping Address",
               "order": 1,
               "status": "completed",
               "valid": true,
               "skippable": false
             },
             {
               "id": "payment",
               "name": "Payment Method",
               "order": 2,
               "status": "current",
               "valid": false,
               "skippable": false,
               "prerequisites": ["shipping"]
             },
             {
               "id": "review",
               "name": "Review Order",
               "order": 3,
               "status": "locked",
               "valid": false,
               "skippable": false,
               "prerequisites": ["shipping", "payment"]
             },
             {
               "id": "confirmation",
               "name": "Confirmation",
               "order": 4,
               "status": "locked",
               "valid": false,
               "skippable": false,
               "prerequisites": ["shipping", "payment", "review"]
             }
           ],
           "current_step": "payment",
           "completed_steps": ["shipping"],
           "blocking_issues": ["payment_method_required"]
         }'>
      
      <!-- Step Indicator -->
      <div class="step-indicator" data-agent="workflow-steps">
        <div class="step completed" 
             data-agent-step="shipping"
             data-agent-step-status="completed"
             data-agent-step-order="1">
          ‚úì Shipping
        </div>
        <div class="step current" 
             data-agent-step="payment"
             data-agent-step-status="current"
             data-agent-step-order="2">
           Payment
        </div>
        <div class="step locked" 
             data-agent-step="review"
             data-agent-step-status="locked"
             data-agent-step-order="3">
          Review
        </div>
        <div class="step locked" 
             data-agent-step="confirmation"
             data-agent-step-status="locked"
             data-agent-step-order="4">
          Done
        </div>
      </div>

      <!-- COMPLETED: Shipping Address (shown as summary) -->
      <div data-agent-step-content="shipping" class="step-content" style="display: none;">
        <h3>‚úì Shipping Address Verified</h3>
        <p>John Doe<br>123 Main St<br>New York, NY 10001<br>United States</p>
        <button class="secondary" data-agent="action" data-agent-name="edit_shipping">Edit</button>
      </div>

      <!-- CURRENT: Payment Method -->
      <div data-agent-step-content="payment" class="step-content">
        <h3>üí≥ Payment Method</h3>
        
        <form data-agent="action"
              data-agent-name="save_payment"
              data-agent-method="POST"
              data-agent-endpoint="/api/checkout/payment"
              data-agent-requires-step="payment">
          
          <label>
            Card Number
            <input data-agent-param="payment.card_number"
                   data-agent-typehint="string"
                   data-agent-validation='{
                     "pattern": "^[0-9]{16}$",
                     "pattern_message": "Please enter a valid 16-digit card number"
                   }'
                   type="text"
                   placeholder="1234 5678 9012 3456"
                   maxlength="16"
                   required>
          </label>
          
          <div style="display: flex; gap: 1rem;">
            <label style="flex: 1;">
              Expiry Date
              <input data-agent-param="payment.expiry"
                     data-agent-validation='{
                       "pattern": "^(0[1-9]|1[0-2])\\/([0-9]{2})$",
                       "pattern_message": "Format: MM/YY"
                     }'
                     type="text"
                     placeholder="MM/YY"
                     maxlength="5"
                     required>
            </label>
            <label style="flex: 1;">
              CVV
              <input data-agent-param="payment.cvv"
                     data-agent-typehint="string"
                     data-agent-validation='{
                       "pattern": "^[0-9]{3,4}$"
                     }'
                     type="text"
                     placeholder="123"
                     maxlength="4"
                     required>
            </label>
          </div>
          
          <label>
            Cardholder Name
            <input data-agent-param="payment.cardholder_name"
                   data-agent-typehint="string"
                   type="text"
                   placeholder="John Doe"
                   required>
          </label>
          
          <div style="margin-top: 1.5rem;">
            <!-- 
              CONTINUATION ACTION
              
              Advances to next step. The workflow state is updated server-side
              when this action succeeds.
            -->
            <button type="submit" class="primary">
              Continue to Review ‚Üí
            </button>
            
            <!-- 
              BACK ACTION
              
              data-agent-workflow-nav="back" indicates navigation within workflow
            -->
            <button type="button" 
                    class="secondary"
                    data-agent="action"
                    data-agent-name="go_to_shipping"
                    data-agent-workflow-nav="back"
                    data-agent-target-step="shipping">
              ‚Üê Back to Shipping
            </button>
          </div>
        </form>
        
        <!-- Validation warning -->
        <div class="warning" style="margin-top: 1rem;">
          <strong>‚ö†Ô∏è Payment Required</strong><br>
          You must add a payment method before reviewing your order.
        </div>
      </div>

      <!-- LOCKED: Review Order -->
      <div data-agent-step-content="review" class="step-content hidden">
        <h3>üìã Review Your Order</h3>
        
        <div class="order-summary">
          <h4>Items</h4>
          <div data-agent="resource" data-agent-type="order-item">
            <div style="display: flex; justify-content: space-between; margin: 0.5rem 0;">
              <span data-agent-prop="name">Premium Widget x2</span>
              <span data-agent-prop="price" data-agent-typehint="currency" data-agent-currency="USD">$199.98</span>
            </div>
          </div>
          <hr>
          <div style="display: flex; justify-content: space-between; font-weight: bold;">
            <span>Total</span>
            <span data-agent-prop="total" data-agent-typehint="currency" data-agent-currency="USD">$199.98</span>
          </div>
        </div>
        
        <div style="margin-top: 1.5rem;">
          <button data-agent="action"
                  data-agent-name="confirm_order"
                  data-agent-method="POST"
                  data-agent-endpoint="/api/checkout/confirm"
                  data-agent-requires-steps="shipping,payment"
                  data-agent-requires-all="true"
                  data-agent-risk="high"
                  data-agent-cost="199.98"
                  data-agent-cost-currency="USD"
                  class="success">
            ‚úì Place Order - $199.98
          </button>
          
          <button class="secondary"
                  data-agent="action"
                  data-agent-name="go_to_payment"
                  data-agent-workflow-nav="back">
            ‚Üê Back
          </button>
        </div>
        
        <!-- 
          HIGH-RISK CONFIRMATION
          
          The agent would show a confirmation dialog with:
          - Order total with currency
          - Item list
          - Shipping address
          - Payment method (last 4 digits)
        -->
      </div>

      <!-- LOCKED: Confirmation -->
      <div data-agent-step-content="confirmation" class="step-content hidden">
        <h3>üéâ Order Confirmed!</h3>
        <p>Your order <strong data-agent-prop="order_number">#ORD-2025-001</strong> has been placed.</p>
        <p>Confirmation sent to your email.</p>
        <a href="/orders/ORD-2025-001" class="button primary" style="display: inline-block; text-decoration: none;">View Order Details</a>
      </div>

    </div>

    <!-- Workflow State Display (for debugging/educational purposes) -->
    <div style="margin-top: 2rem; padding: 1rem; background: #f5f5f5; border-radius: 4px; font-family: monospace; font-size: 0.85rem;">
      <strong>Agent View - Workflow State:</strong>
      <pre id="workflowState">{
  "workflow_id": "checkout-2025-001",
  "current_step": "payment",
  "completed_steps": ["shipping"],
  "prerequisites_met": {
    "shipping": true,
    "payment": false,
    "review": false,
    "confirmation": false
  },
  "available_actions": [
    "save_payment (current step)",
    "go_to_shipping (back navigation)"
  ],
  "locked_actions": [
    "confirm_order (missing prerequisite: payment)"
  ]
}</pre>
    </div>

  </main>

  <script>
    // Simple demo to show step progression
    document.querySelector('form').addEventListener('submit', function(e) {
      e.preventDefault();
      alert('Payment saved! In a real implementation, the server would update workflow state and the agent would observe the change to current_step.');
    });
  </script>

</body>
</html>
